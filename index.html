<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafik Transportu - Diakonat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        [v-cloak] { display: none; }
        .add-form { background-color: #f9fafb; border-top: 1px dashed #d1d5db; }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto p-4 min-h-screen pb-24">
    
    <header class="mb-6 text-center">
        <h1 class="text-2xl font-bold text-gray-800">Transport Kościelny</h1>
        <p class="text-sm text-gray-500">Harmonogram przejazdów</p>
    </header>

    <div v-if="loading" class="text-center py-10 text-gray-500">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
        <div>Ładowanie danych...</div>
    </div>

    <div v-else>
        <!-- Sekcja: Sugerowany Kierowca -->
        <div class="card p-4 mb-6 border-l-4 border-blue-500">
            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Kolejka (Sugestia)</h2>
            <div class="text-xl font-bold text-gray-800">
                {{ prettyName(suggestedDriver) || 'Wszyscy aktywni kierowcy jeździli niedawno' }}
            </div>
            <p class="text-xs text-gray-500 mt-1 leading-snug">
                {{ suggestionReason }}
            </p>
        </div>

        <!-- Sekcja: Najbliższe terminy -->
        <div class="mb-8">
            <h2 class="text-lg font-bold text-gray-700 mb-3">Najbliższe terminy</h2>
            
            <div v-for="week in upcomingWeeks" :key="week.date" class="card mb-4 overflow-hidden">
                
                <!-- Nagłówek Daty -->
                <div class="bg-white p-4 border-b border-gray-100 flex justify-between items-center">
                    <span class="font-bold text-lg text-gray-800 capitalize">{{ formatDate(week.date) }}</span>
                    <span v-if="week.trips.length > 0" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">
                        Zaplanowane: {{ week.trips.length }}
                    </span>
                    <span v-else class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full font-bold">Pusto</span>
                </div>

                <!-- Lista zaplanowanych przejazdów w ten dzień -->
                <div v-if="week.trips.length > 0" class="p-2 space-y-2 bg-white">
                    <div v-for="trip in week.trips" :key="trip.id" class="flex justify-between items-center bg-white p-3 rounded border border-gray-200 shadow-sm relative overflow-hidden">
                        
                        <!-- Pasek koloru zależny od typu -->
                        <div class="absolute left-0 top-0 bottom-0 w-1" 
                             :class="{
                                'bg-green-500': trip.trip_type === 'both',
                                'bg-blue-400': trip.trip_type === 'to',
                                'bg-orange-400': trip.trip_type === 'from'
                             }"></div>

                        <div class="pl-2 w-full">
                            <!-- Pasażer i Typ -->
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-gray-800">{{ trip.passenger }}</span>
                                
                                <span v-if="trip.trip_type === 'both'" class="text-[10px] font-bold uppercase bg-green-100 text-green-700 px-2 py-0.5 rounded border border-green-200">
                                    W obie strony
                                </span>
                                <span v-else-if="trip.trip_type === 'to'" class="text-[10px] font-bold uppercase bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-200">
                                    Tylko Tam &rarr;
                                </span>
                                <span v-else-if="trip.trip_type === 'from'" class="text-[10px] font-bold uppercase bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200">
                                    &larr; Tylko Powrót
                                </span>
                            </div>

                            <!-- Kierowca (Wyświetlany ładnie dzięki prettyName) -->
                            <div class="mt-1 flex items-center text-sm text-gray-600">
                                <span class="text-xs uppercase font-bold mr-1 text-gray-400">Kierowca:</span>
                                {{ prettyName(trip.driver_name) }}
                            </div>
                        </div>

                        <button @click="removeDriver(trip.id)" class="text-gray-300 hover:text-red-500 p-2 ml-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Formularz dodawania -->
                <div class="add-form p-4">
                    <p class="text-xs text-gray-400 uppercase font-bold mb-2">
                        {{ week.trips.length > 0 ? '+ Dodaj kolejny transport' : 'Zaplanuj transport' }}
                    </p>
                    <div class="flex flex-col gap-2">
                        <!-- Wybór Pasażera -->
                        <select v-model="week.newEntry.passenger" class="w-full p-2 border border-gray-300 rounded text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="" disabled>-- Kogo wieziemy? --</option>
                            <option v-for="p in passengers" :value="p.name">{{ p.name }}</option>
                        </select>

                        <!-- Wybór Rodzaju Kursu -->
                        <div class="flex items-center gap-2">
                            <select v-model="week.newEntry.type" class="w-1/2 p-2 border border-gray-300 rounded text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none text-gray-700">
                                <option value="both">W obie strony</option>
                                <option value="to">Tylko TAM &rarr;</option>
                                <option value="from">&larr; Tylko POWRÓT</option>
                            </select>

                            <!-- Wybór Kierowcy (Tutaj lista jest nadal Nazwisko, Imię dla sortowania) -->
                            <select v-model="week.newEntry.driver" class="w-1/2 p-2 border border-gray-300 rounded text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="" disabled selected>-- Kto? --</option>
                                <option v-for="driver in drivers" :value="driver.name">{{ driver.name }}</option>
                            </select>
                        </div>
                            
                        <button @click="assignDriver(week)" 
                                :disabled="!week.newEntry.driver || !week.newEntry.passenger"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm mt-1">
                            Zapisz przejazd
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sekcja: Zarządzanie (Zwijana) -->
        <div class="space-y-3 mb-8">
            <div class="card p-3">
                <button @click="uiState.showAddDriver = !uiState.showAddDriver" class="flex justify-between items-center w-full text-sm font-bold text-gray-700">
                    <span>Baza Kierowców</span>
                    <span class="text-blue-500 font-normal text-xs">{{ drivers.length }} osób {{ uiState.showAddDriver ? '▲' : '▼' }}</span>
                </button>
                <div v-if="uiState.showAddDriver" class="mt-3 pt-2 border-t">
                    <div class="flex gap-2">
                        <input v-model="newDriverName" type="text" placeholder="Imię i Nazwisko" class="flex-1 p-2 border rounded text-sm">
                        <button @click="addNewPerson('drivers', newDriverName)" class="bg-gray-800 text-white px-3 py-2 rounded text-sm">Dodaj</button>
                    </div>
                </div>
            </div>
            <div class="card p-3">
                <button @click="uiState.showAddPassenger = !uiState.showAddPassenger" class="flex justify-between items-center w-full text-sm font-bold text-gray-700">
                    <span>Baza Pasażerów</span>
                    <span class="text-blue-500 font-normal text-xs">{{ passengers.length }} osób {{ uiState.showAddPassenger ? '▲' : '▼' }}</span>
                </button>
                <div v-if="uiState.showAddPassenger" class="mt-3 pt-2 border-t">
                    <div class="flex gap-2">
                        <input v-model="newPassengerName" type="text" placeholder="Imię i Nazwisko" class="flex-1 p-2 border rounded text-sm">
                        <button @click="addNewPerson('passengers', newPassengerName)" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm">Dodaj</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historia -->
        <div class="opacity-60 hover:opacity-100 transition-opacity">
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2">Historia (ostatnie 3 msc)</h2>
            <div v-if="history.length === 0" class="text-gray-400 text-sm italic">Brak historii przejazdów.</div>
            <ul class="bg-white rounded-xl shadow-sm overflow-hidden">
                <li v-for="trip in history" :key="trip.id" class="flex justify-between items-center p-3 border-b border-gray-100 last:border-0 text-sm">
                    <span class="text-gray-500 text-xs">{{ formatDate(trip.date) }}</span>
                    <div class="text-right">
                        <!-- Tutaj też używamy prettyName -->
                        <span class="block font-bold text-gray-800">{{ prettyName(trip.driver_name) }}</span>
                        <div class="text-xs text-gray-500">
                            {{ trip.passenger }}
                            <span v-if="trip.trip_type === 'to'" class="text-blue-500">(tylko tam)</span>
                            <span v-if="trip.trip_type === 'from'" class="text-orange-500">(tylko powrót)</span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

    </div>
</div>

<script>
    // ---------------------------------------------------------
    // WPISZ DANE SUPABASE TUTAJ
    // ---------------------------------------------------------
    const SUPABASE_URL = 'https://mniipgqpekhxbrzmwrtz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uaWlwZ3FwZWtoeGJyem13cnR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0OTY0NDAsImV4cCI6MjA4NTA3MjQ0MH0.MXI-k9bczgDmuCxJZi4QH9noOZBMZo1f06ro9c8qsuQ';
    // ---------------------------------------------------------

    const { createClient } = supabase;
    const _supabase = (SUPABASE_URL.includes('TWOJ') || SUPABASE_KEY.includes('TWOJ')) 
        ? null 
        : createClient(SUPABASE_URL, SUPABASE_KEY);

    const { createApp, ref, reactive, onMounted } = Vue;

    createApp({
        setup() {
            const loading = ref(true);
            const drivers = ref([]);
            const passengers = ref([]);
            const upcomingWeeks = ref([]);
            const history = ref([]);
            
            const uiState = reactive({
                showAddDriver: false,
                showAddPassenger: false
            });
            const newDriverName = ref('');
            const newPassengerName = ref('');
            const suggestedDriver = ref('');
            const suggestionReason = ref('');

            const fetchData = async () => {
                if (!_supabase) {
                    alert("UZUPEŁNIJ KLUCZE SUPABASE W KODZIE HTML!");
                    loading.value = false;
                    return;
                }
                loading.value = true;
                
                const [driversRes, passengersRes, tripsRes] = await Promise.all([
                    _supabase.from('drivers').select('*').order('name'),
                    _supabase.from('passengers').select('*').order('name'),
                    _supabase.from('trips').select('*').order('date', { ascending: false })
                ]);

                drivers.value = driversRes.data || [];
                passengers.value = passengersRes.data || [];
                const allTrips = tripsRes.data || [];

                const today = new Date().toISOString().split('T')[0];
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                history.value = allTrips.filter(t => t.date < today && new Date(t.date) > threeMonthsAgo);
                generateUpcomingWeeks(allTrips);
                calculateSuggestion(allTrips);
                loading.value = false;
            };

            const generateUpcomingWeeks = (allTrips) => {
                const weeks = [];
                let d = new Date();
                d.setDate(d.getDate() + (6 - d.getDay() + 7) % 7);

                for (let i = 0; i < 5; i++) {
                    const dateStr = d.toISOString().split('T')[0];
                    const tripsThisDay = allTrips.filter(t => t.date === dateStr);
                    
                    const takenPassengers = tripsThisDay.map(t => t.passenger);
                    let suggestedPassenger = '';
                    const availablePassenger = passengers.value.find(p => !takenPassengers.includes(p.name));
                    
                    if (availablePassenger) {
                        suggestedPassenger = availablePassenger.name;
                    } else if (passengers.value.length > 0) {
                        suggestedPassenger = ''; 
                    }

                    weeks.push({
                        date: dateStr,
                        trips: tripsThisDay,
                        newEntry: { 
                            passenger: suggestedPassenger, 
                            driver: '',
                            type: 'both'
                        }
                    });
                    
                    d.setDate(d.getDate() + 7);
                }
                upcomingWeeks.value = weeks;
            };

            const calculateSuggestion = (allTrips) => {
                if (drivers.value.length === 0) return;
                const driverNames = drivers.value.map(d => d.name);
                const pastDrivers = allTrips.filter(t => t.driver_name).map(t => t.driver_name);
                const neverDriven = driverNames.filter(name => !pastDrivers.includes(name));

                if (neverDriven.length > 0) {
                    const randomIdx = Math.floor(Math.random() * neverDriven.length);
                    suggestedDriver.value = neverDriven[randomIdx];
                    suggestionReason.value = "Ta osoba jeszcze nigdy nie wiozła nikogo.";
                } else {
                    const lastDriveMap = {};
                    allTrips.forEach(t => {
                        if (!t.driver_name) return;
                        if (!lastDriveMap[t.driver_name]) lastDriveMap[t.driver_name] = t.date;
                    });
                    const sortedByDate = driverNames.sort((a, b) => {
                        const dateA = lastDriveMap[a] || '1970-01-01';
                        const dateB = lastDriveMap[b] || '1970-01-01';
                        return new Date(dateA) - new Date(dateB);
                    });
                    suggestedDriver.value = sortedByDate[0];
                    const lastDate = lastDriveMap[sortedByDate[0]];
                    suggestionReason.value = `Ostatnio jechał: ${lastDate ? formatDate(lastDate) : 'brak danych'}.`;
                }
            };

            const assignDriver = async (week) => {
                const entry = week.newEntry;
                if (!entry.driver || !entry.passenger) return;
                
                const { error } = await _supabase.from('trips').insert({
                    date: week.date,
                    driver_name: entry.driver,
                    passenger: entry.passenger,
                    trip_type: entry.type
                });

                if (error) alert('Błąd: ' + error.message);
                else await fetchData();
            };

            const removeDriver = async (tripId) => {
                if(!confirm("Czy usunąć ten przejazd?")) return;
                const { error } = await _supabase.from('trips').delete().eq('id', tripId);
                if (error) alert('Błąd');
                else await fetchData();
            };

            const addNewPerson = async (table, nameRef) => {
                if (!nameRef) return;
                
                let nameToSave = nameRef;

                // --- LOGIKA AUTOMATYCZNEGO FORMATOWANIA ---
                // Jeśli dodajemy KIEROWCĘ i nie wpisano przecinka (np. "Jan Kowalski")
                // to zamień na "Kowalski, Jan".
                if (table === 'drivers' && !nameToSave.includes(',')) {
                    const parts = nameToSave.trim().split(' ');
                    // Jeśli są przynajmniej 2 słowa (Imię i Nazwisko)
                    if (parts.length > 1) {
                        const surname = parts.pop(); // Ostatnie słowo to nazwisko
                        const name = parts.join(' '); // Reszta to imiona
                        nameToSave = `${surname}, ${name}`;
                    }
                }
                // -------------------------------------------

                const { error } = await _supabase.from(table).insert({ name: nameToSave });
                if (error) alert('Błąd: ' + error.message);
                else {
                    if (table === 'drivers') newDriverName.value = '';
                    if (table === 'passengers') newPassengerName.value = '';
                    await fetchData();
                }
            };

            const formatDate = (dateStr) => {
                const d = new Date(dateStr);
                return d.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', weekday: 'long' });
            };
            
            // --- FUNKCJA PRETTY NAME ---
            // Zamienia "Kowalski, Jan" -> "Jan Kowalski" tylko przy wyświetlaniu
            const prettyName = (name) => {
                if (!name) return '';
                if (name.includes(',')) {
                    const parts = name.split(',');
                    // parts[0] to Nazwisko, parts[1] to Imię
                    // Zwracamy "Imię Nazwisko"
                    return (parts[1] + ' ' + parts[0]).trim();
                }
                return name;
            };

            onMounted(() => {
                fetchData();
            });

            return {
                loading, drivers, passengers, upcomingWeeks, history, 
                uiState, newDriverName, newPassengerName, addNewPerson,
                suggestedDriver, suggestionReason,
                assignDriver, removeDriver, formatDate, prettyName
            };
        }
    }).mount('#app');
</script>

</body>
</html>
